# 购房决策智能助手 - 架构设计文档

## 概述

本文档定义了购房决策智能助手的技术架构设计。

**对外表述**: 多智能体协作系统  
**内部实现**: 伪多Agent（单Agent + 多角色 + 多工具）  
**技术栈**: FastAPI + 手搓Agent + DeepSeek API  
**目标城市**: 广西南宁、柳州

> 注：对外宣传使用"多智能体"概念，内部实现采用更高效的伪多Agent架构，效果等同但开发成本更低。

---

## 一、架构选型分析

### 1.1 方案对比

| 方案 | 开发周期 | 调试难度 | 效果 | 稳定性 |
|------|---------|---------|------|--------|
| 单Agent + 多工具 | 2-3周 | 简单 | 够用 | 高 |
| 真多Agent协作 | 5-6周 | 复杂 | 更好 | 中 |
| **伪多Agent（选用）** | 3-4周 | 中等 | 好 | 高 |

### 1.2 选择伪多Agent的理由

1. **演示效果好**：展示多角色协作，比赛更有亮点
2. **开发成本可控**：本质是单Agent，不需要处理Agent间通信
3. **稳定可靠**：单一控制流，不会出现协作冲突
4. **易于扩展**：后期可平滑升级为真多Agent

---

## 二、伪多Agent架构设计

### 2.1 核心思想

**一个大脑，多个人格**

- 本质是单Agent，但内部定义多个专业角色
- 根据用户意图，切换到对应角色的Prompt
- 复杂问题可以调用多个角色，最后整合输出

### 2.2 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户输入                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       主控Agent                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    意图识别                               │   │
│  │         识别用户问题类型，确定需要哪些角色                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│         ┌────────────────────┼────────────────────┐            │
│         ▼                    ▼                    ▼            │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐      │
│  │  财务顾问    │     │  政策专家    │     │ 市场分析师   │      │
│  │             │     │             │     │             │      │
│  │ • 贷款计算   │     │ • 政策检索   │     │ • 市场查询   │      │
│  │ • 税费计算   │     │ • FAQ检索    │     │ • 走势分析   │      │
│  │ • 成本汇总   │     │ • 流程指导   │     │ • 区域对比   │      │
│  │ • 压力评估   │     │             │     │ • 时机判断   │      │
│  └─────────────┘     └─────────────┘     └─────────────┘      │
│         │                    │                    │            │
│         └────────────────────┼────────────────────┘            │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    购房顾问                               │   │
│  │              整合各角色结果，生成综合建议                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         输出回答                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 角色定义

#### 财务顾问 (Financial Advisor)

```python
{
    "role_id": "financial_advisor",
    "name": "财务顾问",
    "icon": "💰",
    "description": "专业的购房财务顾问，擅长贷款计算、税费分析、还款压力评估",
    "system_prompt": """你是专业的购房财务顾问，具备以下能力：
    - 精通公积金贷款、商业贷款、组合贷款的计算
    - 熟悉各类购房税费（契税、增值税、个税、中介费等）
    - 能够评估用户的还款压力和购房能力
    - 给出专业、准确、易懂的财务建议
    
    回答风格：专业严谨，数据准确，给出具体数字""",
    "tools": [
        "calc_loan",
        "calc_monthly_payment", 
        "generate_repayment_plan",
        "calc_tax",
        "calc_total_cost",
        "assess_pressure"
    ],
    "trigger_keywords": ["贷款", "月供", "首付", "税费", "能买吗", "买得起", "压力", "成本"]
}
```

#### 政策专家 (Policy Expert)

```python
{
    "role_id": "policy_expert",
    "name": "政策专家",
    "icon": "📋",
    "description": "购房政策专家，熟悉各城市限购限贷政策、公积金政策",
    "system_prompt": """你是购房政策专家，具备以下能力：
    - 熟悉南宁、柳州的限购限贷政策
    - 了解公积金贷款政策和申请条件
    - 掌握购房流程和所需材料
    - 能解答各类购房政策问题
    
    回答风格：准确权威，引用政策来源，说明适用条件""",
    "tools": [
        "search_policy",
        "search_faq",
        "search_guide"
    ],
    "trigger_keywords": ["限购", "政策", "资格", "条件", "公积金", "流程", "材料", "手续"]
}
```

#### 市场分析师 (Market Analyst)

```python
{
    "role_id": "market_analyst",
    "name": "市场分析师",
    "icon": "📈",
    "description": "房地产市场分析师，擅长房价走势分析、区域对比、时机判断",
    "system_prompt": """你是房地产市场分析师，具备以下能力：
    - 分析房价走势和市场趋势
    - 对比不同区域的房价和发展潜力
    - 分析供需关系和去化周期
    - 判断购房时机并给出建议
    
    回答风格：数据驱动，客观分析，给出趋势判断""",
    "tools": [
        "query_market",
        "query_price_trend",
        "compare_districts",
        "judge_timing",
        "search_news"
    ],
    "trigger_keywords": ["房价", "走势", "涨", "跌", "时机", "区域", "对比", "市场", "新闻"]
}
```

#### 购房顾问 (Purchase Consultant)

```python
{
    "role_id": "purchase_consultant",
    "name": "购房顾问",
    "icon": "✅",
    "description": "综合购房顾问，负责整合各方面信息，给出购房建议和行动指导",
    "system_prompt": """你是综合购房顾问，具备以下能力：
    - 整合财务、政策、市场等多方面信息
    - 给出综合性的购房建议
    - 提示潜在风险
    - 规划下一步行动
    
    回答风格：全面综合，建议具体可行，有行动指导""",
    "tools": [
        "generate_report"
    ],
    "trigger_keywords": ["建议", "怎么办", "下一步", "综合", "报告"]
}
```

---

## 三、处理流程

### 3.1 单角色问题

```
用户: "公积金贷款最多能贷多少？"
    ↓
意图识别: 政策问题 → 政策专家
    ↓
调用 search_policy 工具
    ↓
📋【政策专家】回答
```

### 3.2 多角色问题（DAG 调度）

系统采用 **DAG（有向无环图）调度** 实现智能的多角色协作，由 LLM 动态规划执行顺序和依赖关系。

#### 核心数据结构

```python
@dataclass
class ExecutionNode:
    """执行节点"""
    role_id: str              # 角色 ID
    depends_on: list[str]     # 依赖的角色 ID 列表（空表示无依赖）

@dataclass  
class ExecutionPlan:
    """DAG 执行计划"""
    nodes: list[ExecutionNode]  # 节点列表
    reason: str                 # LLM 规划理由
```

#### 调度逻辑

1. **LLM 智能规划**：分析用户问题，返回 DAG 格式的执行计划
2. **依赖分析**：根据 `depends_on` 字段计算执行顺序
3. **并行执行**：无依赖关系的角色使用 `asyncio.gather()` 并行执行
4. **串行执行**：有依赖关系的角色等待依赖完成后执行
5. **上下文传递**：后执行的角色可以获取先执行角色的结果

#### 示例场景

**场景1：独立并行**
```
用户: "外地人在南宁买房要准备多少钱"
    ↓
LLM 规划:
{
  "nodes": [
    {"role_id": "policy_expert", "depends_on": []},
    {"role_id": "financial_advisor", "depends_on": []}
  ],
  "reason": "政策专家查购房资格，财务顾问算费用，两者独立可并行"
}
    ↓
执行: 政策专家 ║ 财务顾问  （并行执行，约 30 秒）
    ↓
输出两个角色的结果
```

**场景2：串行依赖**
```
用户: "根据南宁公积金政策帮我算下能贷多少"
    ↓
LLM 规划:
{
  "nodes": [
    {"role_id": "policy_expert", "depends_on": []},
    {"role_id": "financial_advisor", "depends_on": ["policy_expert"]}
  ],
  "reason": "财务计算需要政策专家提供的公积金额度信息，需串行"
}
    ↓
执行: 政策专家 → 财务顾问（串行执行，财务顾问获取政策结果）
    ↓
输出综合结果
```

**场景3：混合调度（并行+串行）**
```
用户: "我想在南宁买150万的房子，月入1.5万，现在是好时机吗"
    ↓
LLM 规划:
{
  "nodes": [
    {"role_id": "policy_expert", "depends_on": []},
    {"role_id": "financial_advisor", "depends_on": []},
    {"role_id": "market_analyst", "depends_on": []},
    {"role_id": "purchase_consultant", "depends_on": ["policy_expert", "financial_advisor", "market_analyst"]}
  ],
  "reason": "政策、财务、市场三者独立可并行，购房顾问最后整合所有结果"
}
    ↓
第1轮: 政策专家 ║ 财务顾问 ║ 市场分析师  （3个角色并行）
第2轮: 购房顾问（等待上述3个完成后执行，整合结果）
    ↓
输出综合建议
```

#### 性能对比

| 场景 | 旧方案（串行） | 新方案（DAG） | 提升 |
|------|--------------|--------------|------|
| 单角色 | ~20秒 | ~20秒 | - |
| 2角色独立 | ~40秒 | ~25秒 | 37% |
| 3角色+整合 | ~80秒 | ~45秒 | 44% |

#### 循环依赖检测

系统使用拓扑排序检测循环依赖，如果检测到循环会自动清除依赖关系：

```python
def _validate_dag(self, nodes: list[ExecutionNode]) -> bool:
    """使用拓扑排序检测循环依赖"""
    # 构建邻接表和入度表
    # 执行拓扑排序
    # 如果访问节点数 < 总节点数，存在循环
    return visited == len(nodes)
```

### 3.3 多角色协作模式

系统支持两种协作模式，用户可通过 API 参数选择：

#### 标准模式（Standard Mode）- 默认

采用 **LLM 智能规划 + DAG 调度 + 并行/串行混合执行**：

```
用户输入
    ↓
1. 意图识别 → LLM 返回 DAG 执行计划（角色 + 依赖关系）
    ↓
2. DAG 调度 → 计算可执行节点（依赖都已完成的节点）
    ↓
3. 执行
   - 单节点：直接执行
   - 多节点：asyncio.gather() 并行执行
    ↓
4. 循环直到所有节点完成
    ↓
5. 输出各角色结果（前端按角色分别展示）
```

**优点**：
- 智能调度：LLM 根据问题语义判断依赖关系
- 并行加速：无依赖的角色并行执行，减少等待时间
- 上下文传递：有依赖的角色可获取前置角色的结果
- 灵活扩展：新增角色无需修改调度逻辑

**适用**：大部分购房咨询问题

#### 高级模式（Discussion Mode）- 可选

采用 **多角色对话协商**，类似 AutoGen：

```
用户输入
    ↓
1. 意图识别 → 确定参与讨论的角色
    ↓
2. 多轮对话协商
   政策专家: "南宁不限购，首套首付20%起"
   财务顾问: "200万首付40万，月供8000，压力大"
   市场分析师: "建议看江南区，150万左右"
   财务顾问: "150万的话月供降到6000，压力中等"
   ... (多轮讨论直到达成共识)
    ↓
3. 购房顾问总结讨论结果
```

**优点**：更深入的分析、可发现更优方案、展示"专家讨论"过程  
**缺点**：延迟高、API 成本高（3-5倍）  
**适用**：复杂的综合性购房决策问题

#### 模式选择

```python
# POST /api/v1/chat
{
    "session_id": "xxx",
    "message": "用户问题",
    "mode": "standard"  # 或 "discussion"
}
```

前端可提供"深度分析"开关，让用户选择是否启用高级模式。

### 3.5 多角色结果展示（折叠方案）

当多个角色并行执行时，系统采用**折叠展示**方案优化用户体验：

#### 问题背景

多角色并行执行会产生多个独立回复，对用户体验不友好：
- 用户需要阅读多个消息
- 信息分散，难以获取核心结论
- 与市面上"一问一答"的交互习惯不符

#### 解决方案

**方案3：折叠展示专家分析**

```
用户: "我想在柳州买房，预算150万，想了解贷款方案和限购政策"
    ↓
并行执行: 政策专家 ║ 财务顾问
    ↓
自动整合: 购房顾问生成综合建议
    ↓
前端展示:
┌─────────────────────────────────────────────┐
│ ✅ 购房顾问 [综合建议]                        │
│                                             │
│ 【核心结论】                                 │
│ 柳州购房政策友好，无户籍与套数限制...          │
│                                             │
│ 【关键要点】                                 │
│ 1. 政策宽松：柳州无限购政策...               │
│ 2. 贷款方案优选：建议优先公积金贷款...        │
│ ...                                         │
│                                             │
│ ▼ 查看专家分析详情 (2位专家)                  │
│ ┌─────────────────────────────────────────┐ │
│ │ 📋 政策专家                              │ │
│ │ 根据查询到的信息，柳州已全面取消限购...    │ │
│ └─────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────┐ │
│ │ 💰 财务顾问                              │ │
│ │ 您好！很高兴为您提供财务规划服务...        │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

#### 实现细节

**后端逻辑** (`backend/app/agent/engine.py`):
```python
# 多角色执行完成后，自动调用购房顾问整合
if len(context.role_results) > 1 and "purchase_consultant" not in context.role_results:
    # 发送整合开始事件，带 is_summary 标记
    yield {"type": "role_start", "role": "purchase_consultant", "is_summary": True}
    
    # 生成整合结果
    summary = await self._synthesize_results(user_input, context)
    
    yield {"type": "role_result", "role": "purchase_consultant", 
           "content": summary, "is_summary": True}
```

**前端逻辑** (`frontend/src/stores/chat.ts`):
```typescript
// 收到整合结果时，删除专家消息，只保留整合消息
if (isSummary) {
    // 移除当前轮次的专家消息
    messages.value = messages.value.filter(m => {
        const isRecent = m.timestamp && (Date.now() - m.timestamp < 60000)
        const isExpert = expertRoleIds.includes(m.roleId)
        return !(isRecent && isExpert)
    })
}

// 整合消息附带专家分析数据
msg.expertAnalysis = [...pendingExpertAnalysis.value]
msg.isSummary = true
```

**组件展示** (`frontend/src/components/chat/RoleMessage.vue`):
- `isSummary` 标记显示"综合建议"标签
- `expertAnalysis` 数组存储专家分析内容
- `showExpertAnalysis` 控制折叠状态
- 点击"查看专家分析详情"展开/收起

#### 测试示例

**输入**: "我想在柳州买房，预算150万，首付50万，想了解贷款方案和限购政策"

**执行过程**:
1. LLM 规划：政策专家 + 财务顾问（并行）
2. 并行执行两个角色（约 25 秒）
3. 自动调用购房顾问整合（约 15 秒）
4. 前端显示整合结果，专家分析可折叠查看

**用户体验**:
- 默认只看到一条综合建议消息
- 想看详情可展开专家分析
- 符合"一问一答"的交互习惯

### 3.6 思考过程展示

为了让用户在等待 AI 响应时有更好的反馈体验，系统实现了类似 ChatGPT/Perplexity 的"思考过程"展示功能。

#### 设计参考

参考了主流 AI 产品的 UI 设计：
- **ChatGPT**: 可展开的研究步骤面板，实时更新，完成后折叠
- **Perplexity**: 来源高亮，简洁的步骤展示
- **Gemini**: 双面板，"Thoughts" 面板显示进度

#### 实现方案

采用类似 ChatGPT 的方式：一个可展开的"思考过程"卡片，实时显示执行步骤。

**后端 SSE 事件** (`backend/app/agent/engine.py`):
```python
# 思考开始
yield {"type": "thinking_start"}

# 思考步骤
yield {
    "type": "thinking_step",
    "step_type": "planning",  # planning/role_dispatch/synthesizing
    "content": "正在分析您的问题..."
}

# 工具调用
yield {
    "type": "tool_call",
    "tool_name": "search_policy",
    "tool_args": "...",
    "role": "policy_expert"
}

# 工具结果
yield {
    "type": "tool_result",
    "tool_name": "search_policy",
    "content": "政策检索 完成"
}
```

**前端组件** (`frontend/src/components/chat/ThinkingProcess.vue`):
- 时间线样式展示步骤
- 不同步骤类型使用不同图标和颜色
- 工具调用显示黄色标签
- 支持展开/折叠

**展示效果**:
```
┌─────────────────────────────────────────────┐
│ ⏳ 思考中...                                 │
│                                             │
│ ● 正在分析您的问题...                        │
│ │                                           │
│ ● 已确定由 政策专家, 财务顾问 为您解答        │
│ │                                           │
│ ● 政策专家正在分析...                        │
│ │                                           │
│ ● 财务顾问正在分析...                        │
│ │                                           │
│ ● 正在调用 政策检索  [调用 政策检索]          │
│ │                                           │
│ ● 政策检索 完成  [调用 政策检索]              │
│ │                                           │
│ ● 正在整合各专家意见，生成综合建议...         │
└─────────────────────────────────────────────┘
```

**折叠后**:
```
┌─────────────────────────────────────────────┐
│ ✓ 思考完成  政策检索 完成                ▼   │
└─────────────────────────────────────────────┘
```

#### 步骤类型

| 类型 | 图标 | 颜色 | 说明 |
|------|------|------|------|
| planning | 📊 | 蓝色 | 意图识别和规划 |
| role_dispatch | 📄 | 绿色 | 角色调度 |
| tool_call | ⚙️ | 黄色 | 工具调用中 |
| tool_result | ✓ | 绿色 | 工具执行完成 |
| synthesizing | 🔍 | 紫色 | 整合结果 |

#### 工具名称映射

前端将英文工具名映射为中文显示：
```typescript
const toolNameMap = {
    'search_policy': '政策检索',
    'search_faq': 'FAQ检索',
    'calc_loan': '贷款计算',
    'calc_tax': '税费计算',
    'query_market': '市场查询'
}
```

### 3.7 完整咨询流程

```
用户: "我想在南宁买房，预算150万，月入1.5万"
    ↓
意图识别: 综合咨询 → 需要全部角色
    ↓
1. 财务顾问: 计算贷款、税费、评估压力
2. 政策专家: 检索限购政策、公积金政策
3. 市场分析师: 分析市场、判断时机
4. 购房顾问: 整合生成综合报告
    ↓
输出完整分析报告
```

---

## 四、技术实现

### 4.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      Web前端 (Vue.js)                            │
│         [对话界面]  [计算器]  [市场分析]  [政策查询]               │
└─────────────────────────────────────────────────────────────────┘
                              │ HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    后端服务 (FastAPI)                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ 用户认证  │  │ 会话管理  │  │ API路由   │  │ 日志监控  │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              伪多Agent引擎 (LangChain)                    │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │   │
│  │  │意图识别  │→│角色选择  │→│工具调用  │→│结果整合  │    │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│         ┌────────────────────┼────────────────────┐            │
│         ▼                    ▼                    ▼            │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐      │
│  │  计算工具    │     │  查询工具    │     │  检索工具    │      │
│  │ calc_loan   │     │query_market │     │search_policy│      │
│  │ calc_tax    │     │query_trend  │     │ search_faq  │      │
│  │ ...         │     │ ...         │     │ ...         │      │
│  └─────────────┘     └─────────────┘     └─────────────┘      │
│         │                    │                    │            │
│         ▼                    ▼                    ▼            │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐      │
│  │ PostgreSQL  │     │   Redis     │     │   Chroma    │      │
│  │  (业务数据)  │     │  (缓存)     │     │  (向量库)   │      │
│  └─────────────┘     └─────────────┘     └─────────────┘      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DeepSeek API                                │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 核心代码结构

```
backend/
├── app/
│   ├── main.py                 # FastAPI入口
│   ├── api/
│   │   ├── chat.py             # 对话接口
│   │   └── calculator.py       # 计算器接口
│   ├── agent/
│   │   ├── engine.py           # 伪多Agent引擎
│   │   ├── roles.py            # 角色定义
│   │   ├── intent.py           # 意图识别
│   │   └── tools/              # 工具集
│   │       ├── financial.py    # 财务计算工具
│   │       ├── market.py       # 市场查询工具
│   │       ├── policy.py       # 政策检索工具
│   │       └── report.py       # 报告生成工具
│   ├── services/
│   │   ├── llm.py              # LLM服务封装
│   │   └── rag.py              # RAG检索服务
│   ├── models/                 # 数据模型
│   └── config/                 # 配置
├── data/                       # 数据文件
├── requirements.txt
└── Dockerfile
```

### 4.3 伪多Agent引擎核心逻辑

```python
class PseudoMultiAgentEngine:
    def __init__(self):
        self.roles = load_roles()  # 加载角色定义
        self.tools = load_tools()  # 加载工具集
        self.llm = init_llm()      # 初始化LLM
    
    async def process(self, user_input: str, context: dict) -> str:
        # 1. 意图识别，确定需要哪些角色
        required_roles = await self.identify_intent(user_input)
        
        # 2. 依次执行每个角色的分析
        role_results = {}
        for role_id in required_roles:
            role = self.roles[role_id]
            result = await self.execute_role(role, user_input, context)
            role_results[role_id] = result
        
        # 3. 整合结果生成最终回答
        if len(required_roles) > 1:
            # 多角色，需要购房顾问整合
            final_response = await self.synthesize(role_results, user_input)
        else:
            # 单角色，直接返回
            final_response = role_results[required_roles[0]]
        
        return final_response
    
    async def execute_role(self, role: dict, user_input: str, context: dict) -> str:
        # 构建角色专属Prompt
        prompt = self.build_role_prompt(role, user_input, context)
        
        # 调用LLM，允许使用角色对应的工具
        response = await self.llm.invoke(
            prompt=prompt,
            tools=role["tools"]
        )
        
        return response
```

---

## 五、数据存储

| 存储 | 用途 | 数据 |
|------|------|------|
| PostgreSQL | 业务数据 | 用户、会话、市场数据、配置 |
| Redis | 缓存 | 会话上下文、热点数据 |
| Chroma | 向量库 | 政策文档、FAQ、流程指南 |
| 文件系统 | 配置 | JSON配置文件 |

---

## 六、技术栈

| 层级 | 技术选型 |
|------|---------|
| 前端 | Vue.js 3 + Vite + Element Plus |
| 后端 | FastAPI + Uvicorn |
| Agent | LangChain |
| LLM | DeepSeek API |
| 数据库 | PostgreSQL + Redis + Chroma |
| 部署 | Docker Compose |

---

## 七、开发计划

| 阶段 | 内容 | 周期 |
|------|------|------|
| Phase 1 | 数据准备（配置、市场、知识库） | 3天 |
| Phase 2 | 后端核心（Agent引擎、工具） | 1周 |
| Phase 3 | RAG检索（政策、FAQ） | 3天 |
| Phase 4 | 前端开发（对话、计算器） | 1周 |
| Phase 5 | 集成测试、优化 | 3天 |

**预计总周期**: 3-4周
